<% nodes.each do |subject, children| %>
  <li class="my-1" data-subject-id="<%= subject.id %>">
    <div class="flex items-center gap-2">
      <% if children.any? %>
        <button type="button"
                class="inline-flex items-center justify-center w-5 h-5 rounded hover:bg-gray-100"
                aria-expanded="false"
                data-tree-toggle>
          <span data-tree-chevron>►</span>
        </button>
      <% else %>
        <span class="inline-block w-5 h-5"></span>
      <% end %>

      <span class="font-medium"><%= subject.name %></span>

      <% case_count = CardTemplate.for_subject(subject).for_kind("Case").count rescue 0 %>
      <span class="ml-1 text-xs text-gray-500">(<%= case_count %>)</span>

      <span class="text-gray-400 text-xs">
        (<%= link_to "Show", subject_path(subject) %> ·
        <%= link_to "Edit", edit_subject_path(subject) %> ·
        <%= button_to "Delete",
              subject_path(subject),
              method: :delete,
              data: { turbo_confirm: "Delete this subject? (Only works if it has no sub-subjects or cases.)" },
              form:  {
                data: { turbo_confirm: "Delete this subject? (Only works if it has no sub-subjects or cases.)" },
                onsubmit: "return confirm('Delete this subject? (Only works if it has no sub-subjects or cases.)')",  # ← hard fallback
                class: "inline"
              },
              class: "underline text-red-600 bg-transparent p-0 border-0 cursor-pointer align-baseline" %>)
      </span>
    </div>

    <% if children.any? %>
      <ul class="border-l border-gray-200 hidden" data-tree-branch
          style="padding-left: <%= (depth + 1) * 1.25 %>rem;">
        <%= render partial: "subject_tree", locals: { nodes: children, depth: depth + 1 } %>
      </ul>
    <% end %>
  </li>
<% end %>