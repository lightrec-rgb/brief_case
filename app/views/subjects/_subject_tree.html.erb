<% nodes.each do |subject, children| %>
  <li class="my-1" data-subject-id="<%= subject.id %>">
    <div class="flex items-center gap-2">
      <% if children.any? %>
        <button type="button"
                class="inline-flex items-center justify-center w-5 h-5 rounded hover:bg-gray-100"
                aria-expanded="false"
                data-tree-toggle>
          <span data-tree-chevron>►</span>
        </button>
      <% else %>
        <span class="inline-block w-5 h-5"></span>
      <% end %>

      <span class="font-medium"><%= subject.name %></span>

      <!-- subtree total (cases + provisions) -->
      <% total_subtree = subtree_case_count(subject, @entry_counts || {}) %>
      <span class="ml-1 inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-700"
            title="Total entries (cases + provisions) in this subject and all children">
        <%= total_subtree %>
      </span>

      <!-- direct entries in this subject only (cases + provisions) -->
      <% entry_count = (CardTemplate.for_subject(subject)
                                   .left_joins(:case_detail, :provision_detail)
                                   .where("cases.id IS NOT NULL OR provisions.id IS NOT NULL")
                                   .count rescue 0) %>
      <span class="ml-1 text-xs text-gray-500">(<%= entry_count %>)</span>

      <span class="text-black text-xs">
        (<%= link_to "Show", subject_path(subject) %> ·
        <%= link_to "Edit", edit_subject_path(subject) %> ·
        <%= button_to "Delete",
              subject_path(subject),
              method: :delete,
              data: { turbo_confirm: "Delete this subject? (Only works if it has no sub-subjects or entries.)" },
              form:  {
                data: { turbo_confirm: "Delete this subject? (Only works if it has no sub-subjects or entries.)" },
                onsubmit: "return confirm('Delete this subject? (Only works if it has no sub-subjects or entries.)')",
                class: "inline"
              },
              class: "text-black bg-transparent p-0 border-0 cursor-pointer align-baseline" %>)
      </span>
    </div>

    <% if children.any? %>
      <ul class="border-l border-gray-200 hidden" data-tree-branch
          style="padding-left: <%= (depth + 1) * 1.25 %>rem;">
        <%= render partial: "subject_tree", locals: { nodes: children, depth: depth + 1 } %>
      </ul>
    <% end %>
  </li>
<% end %>
