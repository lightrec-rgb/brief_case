<%= form_with model: @card,
              url: (@card.persisted? ? entry_path(@card) : entries_path),
              method: (@card.persisted? ? :patch : :post) do |f| %>

  <%= f.hidden_field :kind %>

  <% if @card.errors.any? || @card.case_detail&.errors&.any? || @card.statute_detail&.errors&.any? %>
    <div class="mb-3 rounded border border-red-300 bg-red-50 p-3 text-sm text-red-800">
      <strong>There were problems with your submission:</strong>
      <ul class="list-disc pl-5">
        <% @card.errors.full_messages.each { |m| concat content_tag(:li, m) } %>
        <% @card.case_detail&.errors&.full_messages&.each    { |m| concat content_tag(:li, m) } %>
        <% @card.statute_detail&.errors&.full_messages&.each { |m| concat content_tag(:li, m) } %>
      </ul>
    </div>
  <% end %>

  <div class="grid gap-4">
    <div>
      <%= f.label :subject_id, "Subject" %><br>
      <%= f.select :subject_id,
        options_for_select(
          subject_options_for_select(current_user),
          (params[:subject_id] || @card.subject_id)
        ),
        {},
        class: "border rounded px-2 py-1" %>
    </div>

    <% if @card.kind == "Case" %>
      <%= f.fields_for :case_detail do |c| %>
        <div>
          <%= c.label :case_name, "Case name" %><br>
          <%= c.text_field :case_name, class: "w-full border rounded px-2 py-1", required: true, autofocus: true %>
        </div>

        <div>
          <%= c.label :case_short_name, "Short name" %><br>
          <%= c.text_field :case_short_name, class: "w-full border rounded px-2 py-1" %>
        </div>

        <div>
          <%= c.label :full_citation, "Full citation" %><br>
          <%= c.text_field :full_citation, class: "w-full border rounded px-2 py-1" %>
        </div>

        <div>
          <%= c.label :material_facts %><br>
          <%= c.text_area :material_facts, rows: 6, class: "w-full border rounded px-2 py-1" %>
        </div>

        <div>
          <%= c.label :issue %><br>
          <%= c.text_area :issue, rows: 4, class: "w-full border rounded px-2 py-1" %>
        </div>

        <div>
          <%= c.label :key_principle %><br>
          <%= c.text_area :key_principle, rows: 6, class: "w-full border rounded px-2 py-1" %>
        </div>
      <% end %>

    <% elsif @card.kind == "Statute" %>

      <%# Optional: Saved Acts dropdown for autofill %>
      <% if defined?(@saved_acts) && @saved_acts.present? %>
        <div>
          <label class="text-sm text-gray-600 block mb-1">Use saved Act</label>
          <div class="flex items-center gap-3">
            <select id="saved-act-select" class="border rounded px-2 py-1 flex-grow">
              <option value="">— Select —</option>
              <% @saved_acts.each do |sa| %>
                <option value="<%= sa.id %>"
                        data-subject-id="<%= sa.subject_id %>"  <!-- exact subject match -->
                        data-act-name="<%= sa.act_name %>"
                        data-act-short-name="<%= sa.act_short_name %>"
                        data-jurisdiction="<%= sa.jurisdiction %>"
                        data-year="<%= sa.year %>">
                  <%= sa.display_name %>
                </option>
              <% end %>
            </select>

            <%= link_to "Manage", saved_acts_path,
                        class: "underline text-sm text-blue-600",
                        target: "_blank" %>
          </div>
        </div>
      <% end %>

      <script>
        (function () {
          var actsSel = document.getElementById('saved-act-select');
          var subjSel = document.getElementById('card_template_subject_id'); // Subject <select> generated by f.select :subject_id
          if (!actsSel || !subjSel) return;

          // Injected from controller via load_subject_tree_and_saved_acts
          // e.g., {"10":[10,12,13], "11":[11], ...}
          var subtrees = <%= raw @subject_subtrees.to_json %>;

          function setVal(id, val) {
            var el = document.getElementById(id);
            if (el) {
              el.value = val || '';
              el.dispatchEvent(new Event('input', { bubbles: true }));
            }
          }

          // Show options where the SavedAct's subject_id is inside the selected subject's subtree
          function filterActs() {
            var sid = subjSel.value && subtrees[subjSel.value] ? subtrees[subjSel.value] : [];
            for (var i = 0; i < actsSel.options.length; i++) {
              var opt = actsSel.options[i];
              if (opt.value === '') { opt.hidden = false; continue; }
              var actSid = parseInt(opt.dataset.subjectId || '0', 10);
              var visible = sid.indexOf(actSid) !== -1;
              opt.hidden = !visible;
            }
            // Reset selection if the current option became hidden
            if (actsSel.selectedIndex > 0 && actsSel.options[actsSel.selectedIndex].hidden) {
              actsSel.selectedIndex = 0;
            }
          }

          // Autofill statute fields from the chosen Saved Act
          actsSel.addEventListener('change', function () {
            var opt = actsSel.options[actsSel.selectedIndex];
            if (!opt || !opt.dataset) return;
            setVal('card_template_statute_detail_attributes_act_name',       opt.dataset.actName);
            setVal('card_template_statute_detail_attributes_act_short_name', opt.dataset.actShortName);
            setVal('card_template_statute_detail_attributes_jurisdiction',   opt.dataset.jurisdiction);
            setVal('card_template_statute_detail_attributes_year',           opt.dataset.year);
          });

          // Initial pass (for edit forms) + update on subject change
          filterActs();
          subjSel.addEventListener('change', filterActs);
        })();
        </script>

      <%= f.fields_for :statute_detail do |s| %>
        <div>
          <%= s.label :act_name, "Act name" %><br>
          <%= s.text_field :act_name, id: "card_template_statute_detail_attributes_act_name",
                           class: "w-full border rounded px-2 py-1", required: true, autofocus: true %>
        </div>

        <div>
          <%= s.label :act_short_name, "Short name" %><br>
          <%= s.text_field :act_short_name, id: "card_template_statute_detail_attributes_act_short_name",
                           class: "w-full border rounded px-2 py-1" %>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <%= s.label :jurisdiction, "Jurisdiction" %><br>
            <%= s.text_field :jurisdiction, id: "card_template_statute_detail_attributes_jurisdiction",
                             class: "w-full border rounded px-2 py-1" %>
          </div>
          <div>
            <%= s.label :year, "Year" %><br>
            <%= s.text_field :year, id: "card_template_statute_detail_attributes_year",
                             class: "w-full border rounded px-2 py-1" %>
          </div>
        </div>

        <div>
          <%= s.label :provision_ref, "Provision ref (e.g., s 48(1)(c))" %><br>
          <%= s.text_field :provision_ref, class: "w-full border rounded px-2 py-1", required: true %>
        </div>

        <div>
          <%= s.label :provision_text, "Provision text" %><br>
          <%= s.text_area :provision_text, rows: 6, class: "w-full border rounded px-2 py-1" %>
        </div>
      <% end %>

      <script>
        (function () {
          var sel = document.getElementById('saved-act-select');
          if (!sel) return;

          function setVal(id, val) {
            var el = document.getElementById(id);
            if (el) {
              el.value = val || '';
              el.dispatchEvent(new Event('input', { bubbles: true }));
            }
          }

          sel.addEventListener('change', function () {
            var opt = sel.options[sel.selectedIndex];
            if (!opt || !opt.dataset) return;
            setVal('card_template_statute_detail_attributes_act_name', opt.dataset.actName);
            setVal('card_template_statute_detail_attributes_act_short_name', opt.dataset.actShortName);
            setVal('card_template_statute_detail_attributes_jurisdiction', opt.dataset.jurisdiction);
            setVal('card_template_statute_detail_attributes_year', opt.dataset.year);
          });
        })();
      </script>
    <% end %>

    <div>
      <%= f.submit(@card.persisted? ?
                     (@card.kind == "Statute" ? "Update Statute" : "Update Case") :
                     (@card.kind == "Statute" ? "Create Statute" : "Create Case"),
                   class: "bg-brand-blue text-white px-3 py-2 rounded hover:bg-gold") %>
    </div>
  </div>
<% end %>