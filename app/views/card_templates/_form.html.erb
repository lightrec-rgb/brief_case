<%= form_with model: @card,
              url: (@card.persisted? ? entry_path(@card) : entries_path),
              method: (@card.persisted? ? :patch : :post) do |f| %>

  <%= f.hidden_field :kind %>

  <% if @card.errors.any? || @card.case_detail&.errors&.any? || @card.provision_detail&.errors&.any? %>
    <div class="mb-4 rounded-lg border border-red-300 bg-red-50 p-3 text-sm text-red-800">
      <strong>There were problems with your submission:</strong>
      <ul class="mt-1 list-disc pl-5">
        <% @card.errors.full_messages.each { |m| concat content_tag(:li, m) } %>
        <% @card.case_detail&.errors&.full_messages&.each    { |m| concat content_tag(:li, m) } %>
        <% @card.provision_detail&.errors&.full_messages&.each { |m| concat content_tag(:li, m) } %>
      </ul>
    </div>
  <% end %>

  <div class="space-y-6">
    <!-- Subject -->
    <div>
      <%= f.label :subject_id, "Subject", class: "block text-sm font-medium text-gray-700" %>
      <% selected_subject_id =
            if @card.persisted?
              @card.subject_id
            else
              params[:subject_id].presence || @card.subject_id
            end %>
      <%= f.select :subject_id,
            options_for_select(subject_options_for_select(current_user), selected_subject_id),
            {},
            class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-brand-blue focus:ring-2 focus:ring-brand-blue" %>
    </div>

    <% if @card.kind == "Case" %>
      <%= f.fields_for :case_detail do |c| %>
        <!-- Full citation FIRST -->
        <div>
          <%= c.label :full_citation, "Full citation", class: "block text-sm font-medium text-gray-700" %>
          <%= c.text_field :full_citation,
                class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-brand-blue focus:ring-2 focus:ring-brand-blue",
                placeholder: "e.g., Donoghue v Stevenson [1932] AC 562" %>
        </div>

        <!-- Case name + short name -->
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <%= c.label :case_name, "Case name", class: "block text-sm font-medium text-gray-700" %>
            <%= c.text_field :case_name,
                  class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-brand-blue focus:ring-2 focus:ring-brand-blue",
                  required: true, autofocus: true,
                  placeholder: "e.g., Donoghue v Stevenson" %>
          </div>

          <div>
            <%= c.label :case_short_name, "Short name", class: "block text-sm font-medium text-gray-700" %>
            <%= c.text_field :case_short_name,
                  class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-brand-blue focus:ring-2 focus:ring-brand-blue",
                  placeholder: "Optional — e.g., Snail case" %>
          </div>
        </div>

        <!-- Issue ABOVE facts/principle -->
        <div>
          <%= c.label :issue, "Issue", class: "block font-medium" %>
          <%= c.text_area :issue, rows: 3,
                class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-base shadow-sm focus:border-brand-blue focus:ring-2 focus:ring-brand-blue",
                placeholder: "The central legal question in dispute…" %>
        </div>

        <!-- Facts + Principle side-by-side -->
        <div class="grid gap-6 md:grid-cols-2">
          <div>
            <%= c.label :material_facts, "Material Facts", class: "block text-sm font-medium text-gray-700" %>
            <%= c.text_area :material_facts, rows: 11,
              class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-base shadow-sm focus:border-brand-blue focus:ring-2 focus:ring-brand-blue min-h-[12rem]",
              placeholder: "Key facts relevant to the decision…" %>
          </div>

          <div>
            <%= c.label :key_principle, "Key Principle", class: "block text-sm font-medium text-gray-700" %>
            <%= c.text_area :key_principle, rows: 11,
              class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-base shadow-sm focus:border-brand-blue focus:ring-2 focus:ring-brand-blue min-h-[12rem]",
              placeholder: "The rule or takeaway established by the case…" %>
          </div>
        </div>
      <% end %>

    <% elsif @card.kind == "Provision" %>
      <%# unchanged warning panel... %>
    <% end %>

    <!-- Actions -->
    <div class="pt-2">
      <%= f.submit(@card.persisted? ?
                     (@card.kind == "Provision" ? "Update (use Act → Edit Provision)" : "Update Case") :
                     (@card.kind == "Provision" ? "Create (use Act → Add Provision)" : "Create Case"),
                   class: "inline-flex items-center rounded-md bg-brand-blue px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-gold focus:outline-none focus:ring-2 focus:ring-brand-blue",
                   disabled: (@card.kind == "Provision")) %>
    </div>
  </div>
<% end %>
