<%= form_with model: @card,
              url: (@card.persisted? ? entry_path(@card) : entries_path),
              method: (@card.persisted? ? :patch : :post) do |f| %>

  <%= f.hidden_field :kind %>

  <% if @card.errors.any? || @card.case_detail&.errors&.any? || @card.provision_detail&.errors&.any? %>
    <div class="mb-3 rounded border border-red-300 bg-red-50 p-3 text-sm text-red-800">
      <strong>There were problems with your submission:</strong>
      <ul class="list-disc pl-5">
        <% @card.errors.full_messages.each { |m| concat content_tag(:li, m) } %>
        <% @card.case_detail&.errors&.full_messages&.each    { |m| concat content_tag(:li, m) } %>
        <% @card.provision_detail&.errors&.full_messages&.each { |m| concat content_tag(:li, m) } %>
      </ul>
    </div>
  <% end %>

  <div class="grid gap-4">
    <div>
      <%= f.label :subject_id, "Subject" %><br>
      <%= f.select :subject_id,
        options_for_select(
          subject_options_for_select(current_user),
          (params[:subject_id] || @card.subject_id)
        ),
        {},
        class: "border rounded px-2 py-1" %>
    </div>

    <% if @card.kind == "Case" %>
      <%= f.fields_for :case_detail do |c| %>
        <div>
          <%= c.label :case_name, "Case name" %><br>
          <%= c.text_field :case_name, class: "w-full border rounded px-2 py-1", required: true, autofocus: true %>
        </div>

        <div>
          <%= c.label :case_short_name, "Short name" %><br>
          <%= c.text_field :case_short_name, class: "w-full border rounded px-2 py-1" %>
        </div>

        <div>
          <%= c.label :full_citation, "Full citation" %><br>
          <%= c.text_field :full_citation, class: "w-full border rounded px-2 py-1" %>
        </div>

        <div>
          <%= c.label :material_facts %><br>
          <%= c.text_area :material_facts, rows: 6, class: "w-full border rounded px-2 py-1" %>
        </div>

        <div>
          <%= c.label :issue %><br>
          <%= c.text_area :issue, rows: 4, class: "w-full border rounded px-2 py-1" %>
        </div>

        <div>
          <%= c.label :key_principle %><br>
          <%= c.text_area :key_principle, rows: 6, class: "w-full border rounded px-2 py-1" %>
        </div>
      <% end %>

    <% elsif @card.kind == "Provision" %>
      <%# New flow: provisions are created/edited from the Act page, not here. %>
      <div class="rounded border border-amber-300 bg-amber-50 p-3 text-sm">
        <p class="font-medium">Heads up: manage provisions from the Act page</p>
        <p class="mt-1">
          To <strong>add a provision</strong>, go to <em>Entries → Provisions by Act</em> and click
          <strong>New act</strong> (which creates an Act), then <strong>Add Provision</strong> on that Act.
        </p>

        <% if @card.persisted? && (s = @card.provision_detail) %>
          <hr class="my-3">
          <p class="mb-2">
            This entry is a provision: <span class="font-medium"><%= s.provision_ref.presence || "(no ref)" %></span>
            <% if s.act %>
              in <span class="font-medium"><%= s.act.display_name %></span>.
            <% end %>
          </p>
          <% if s.act %>
            <%= link_to "Edit this provision",
                        edit_act_provision_path(s.act, s),
                        class: "underline text-blue-700" %>
          <% else %>
            <span class="text-gray-600">No Act linked (legacy record).</span>
          <% end %>
        <% end %>
      </div>
    <% end %>

    <div>
      <%= f.submit(@card.persisted? ?
                     (@card.kind == "Provision" ? "Update (use Act → Edit Provision)" : "Update Case") :
                     (@card.kind == "Provision" ? "Create (use Act → Add Provision)" : "Create Case"),
                   class: "bg-brand-blue text-white px-3 py-2 rounded hover:bg-gold",
                   disabled: (@card.kind == "Provision")) %>
    </div>
  </div>
<% end %>
