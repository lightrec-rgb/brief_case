<h1 class="text-2xl font-semibold mb-4">
  Entries
  <% if @subject.present? && @entries.present? %>
    <span class="ml-2 text-sm text-gray-500">(<%= @entries.size %>)</span>
  <% end %>
</h1>

<div class="mb-4 flex items-center gap-3">
  <%= form_with url: entries_path, method: :get, local: true, class: "flex items-center gap-2" do %>
    <label class="text-sm text-gray-600">Subject</label>
    <%= select_tag :subject_id,
      options_for_select(subject_options_for_select(current_user), @subject&.id),
      include_blank: current_user.subjects.empty?,
      class: "border rounded px-2 py-1",
      onchange: "this.form.requestSubmit()" %>
  <% end %>
</div>

<% if @subject.nil? %>
  <p class="text-gray-600">Create a subject first to add entries.</p>
<% else %>
  <% # Partition entries into cases and provisions %>
  <% cases      = @entries.select { |e| e.kind == "Case" } %>
  <% provisions = @entries.select { |e| e.kind == "Provision" } %>

  <!-- CASES SECTION -->
  <section class="mt-6">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-lg font-semibold">Cases in this subject</h2>
      <%= link_to "New case",
            new_entry_path(subject_id: @subject.id, kind: "Case"),
            class: "bg-brand-blue text-white px-3 py-2 rounded hover:bg-gold" %>
    </div>

    <% if cases.none? %>
      <p class="text-gray-600">No cases yet.</p>
    <% else %>
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left border-b">
            <th class="py-1 pr-1 w-1/3">Name</th>
            <th class="py-1 pr-1 w-1/3">Reference</th>
            <th class="py-1 pr-1 w-1/6">Updated</th>
            <th class="py-1 pr-0 w-auto text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% cases.each do |entry| %>
            <% c = entry.case_detail %>
            <tr class="border-b">
              <td class="py-1 pr-1 align-top truncate max-w-[320px]" title="<%= c&.case_name %>">
                <%= c&.case_name.presence || "(untitled)" %>
              </td>
              <td class="py-1 pr-1 align-top break-words max-w-[360px]">
                <%= c&.full_citation.presence || "—" %>
              </td>
              <td class="py-1 pr-1 align-top text-gray-500 whitespace-nowrap">
                <%= l(entry.updated_at, format: :short) %>
              </td>
              <td class="py-1 pr-0 align-top">
                <div class="flex justify-center items-center gap-2 whitespace-nowrap">
                  <%= link_to "Show", entry_path(entry), class: "underline" %>
                  <%= link_to "Edit", edit_entry_path(entry), class: "underline" %>
                  <%= button_to "Delete",
                        entry_path(entry),
                        method: :delete,
                        data: { turbo_confirm: "Delete this case?" },
                        form:  {
                          data: { turbo_confirm: "Delete this case?" },
                          onsubmit: "return confirm('Delete this case?')",
                          class: "inline"
                        },
                        class: "underline text-red-600 bg-transparent p-0 border-0 cursor-pointer align-baseline" %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </section>

  <!-- ACTS SECTION -->
  <section class="mt-10">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-lg font-semibold">Acts in this subject</h2>
      <%= link_to "New act",
            new_act_path(subject_id: @subject.id),
            class: "bg-brand-blue text-white px-3 py-2 rounded hover:bg-gold" %>
    </div>

    <% if @acts.blank? %>
      <p class="text-gray-600">No Acts yet.</p>
    <% else %>
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left border-b">
            <th class="py-1 pr-1 w-1/2">Act</th>
            <th class="py-1 pr-1 w-1/6">Provisions</th>
            <th class="py-1 pr-1 w-1/6">Updated</th>
            <th class="py-1 pr-0 w-1/6 text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @acts.each do |act| %>
            <tr class="border-b" id="act-<%= act.id %>">
              <td class="py-1 pr-1 align-top"><%= act.display_name %></td>
              <td class="py-1 pr-1 align-top"><%= act.provisions.size %></td>
              <td class="py-1 pr-1 align-top text-gray-500 whitespace-nowrap">
                <%= l(act.updated_at, format: :short) %>
              </td>
              <td class="py-2 pr-2">
                <div class="flex justify-center items-center gap-2 whitespace-nowrap">
                  <%= link_to "Add Provision", new_act_provision_path(act), class: "underline" %>
                  <%= link_to "Edit Act", edit_act_path(act), class: "underline" %>
                  <% if act.provisions.exists? %>
                    <span class="text-gray-400" title="Delete provisions first">Delete Act</span>
                  <% else %>
                    <%= button_to "Delete Act",
                          act_path(act),
                          method: :delete,
                          data: { turbo_confirm: "Delete this Act?" },
                          form:  {
                            data: { turbo_confirm: "Delete this Act?" },
                            onsubmit: "return confirm('Delete this Act?')",
                            class: "inline"
                          },
                          class: "underline text-red-600 bg-transparent p-0 border-0 cursor-pointer align-baseline" %>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </section>

  <!-- PROVISIONS BY ACT SECTION -->
  <section class="mt-10">
    <h2 class="text-lg font-semibold mb-2">Provisions by Act</h2>

    <% grouped = provisions.group_by { |e| e.provision_detail&.act || :__unlinked } %>

    <% if provisions.none? %>
      <p class="text-gray-600">No provisions yet.</p>
    <% else %>
      <% grouped.each do |act_or_key, entries_for_act| %>
        <% if act_or_key == :__unlinked %>
          <h3 class="text-md font-semibold mt-6 mb-2">Unlinked provisions</h3>
        <% else %>
          <% act = act_or_key %>
          <div class="flex items-center justify-between">
            <h3 class="text-md font-semibold mt-6 mb-2"><%= act.display_name %></h3>
            <div>
              <%= link_to "Add Provision", new_act_provision_path(act), class: "underline text-sm" %>
            </div>
          </div>
        <% end %>

        <table class="w-full text-sm mb-4">
          <thead>
            <tr class="text-left border-b">
              <th class="py-1 pr-1 w-1/2">Provision ref</th>
              <th class="py-1 pr-1 w-1/6">Updated</th>
              <th class="py-1 pr-0  w-1/6 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% entries_for_act.each do |entry| %>
              <% s = entry.provision_detail %>
              <tr class="border-b">
                <td class="py-1 pr-1 align-top whitespace-nowrap">
                  <%= link_to(s&.provision_ref.presence || "—",
                              entry_path(entry),
                              class: "underline") %>
                </td>
                <td class="py-1 pr-1 align-top text-gray-500 whitespace-nowrap">
                  <%= l(entry.updated_at, format: :short) %>
                </td>
                <td class="py-1 pr-0 align-top">
                  <div class="flex justify-center items-center gap-2 whitespace-nowrap">
                    <% if s&.act %>
                      <%= link_to "Edit", edit_act_provision_path(s.act, s), class: "underline" %>
                      <%= button_to "Delete",
                            act_provision_path(s.act, s),
                            method: :delete,
                            data: { turbo_confirm: "Delete this provision?" },
                            form:  {
                              data: { turbo_confirm: "Delete this provision?" },
                              onsubmit: "return confirm('Delete this provision?')",
                              class: "inline"
                            },
                            class: "underline text-red-600 bg-transparent p-0 border-0 cursor-pointer align-baseline" %>
                    <% else %>
                      <span class="text-gray-400">No Act</span>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
    <% end %>
  </section>
<% end %>
