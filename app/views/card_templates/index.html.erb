<h1 class="text-xl font-semibold mb-4">
  Entries
  <% if @subject.present? && @entries.present? %>
    <span class="ml-2 text-sm text-gray-500">(<%= @entries.size %>)</span>
  <% end %>
</h1>

<div class="mb-4">
  <%= form_with url: entries_path, method: :get, local: true, class: "flex items-center gap-2" do %>
    <label class="text-sm text-gray-600">Subject</label>
    <%= select_tag :subject_id,
      options_for_select(subject_options_for_select(current_user), @subject&.id),
      include_blank: current_user.subjects.empty?,
      class: "border rounded px-2 py-1",
      onchange: "this.form.requestSubmit()" %>
  <% end %>
</div>

<% if @subject.nil? %>
  <p class="text-gray-600">Create a subject first to add entries.</p>
<% else %>
  <% entries   = @entries || [] %>
  <% cases     = entries.select { |e| e.kind == "Case" } %>
  <% statutes  = entries.select { |e| e.kind == "Statute" } %>
  <% grouped   = statutes.group_by { |e| e.statute_detail&.act } %>

  <!-- ——— Cases section ——— -->
  <div class="mt-6 mb-2 flex items-center justify-between">
    <h2 class="text-lg font-semibold">
      Cases <span class="text-sm text-gray-500">(<%= cases.size %>)</span>
    </h2>
    <%= link_to "New case",
          new_entry_path(subject_id: @subject.id, kind: "Case"),
          class: "bg-brand-blue text-white px-3 py-2 rounded hover:bg-gold" %>
  </div>

  <% if cases.any? %>
    <table class="w-full text-sm mb-8">
      <thead>
        <tr class="text-left border-b">
          <th class="py-1 pr-1 w-1/3">Name</th>
          <th class="py-1 pr-1 w-1/3">Citation</th>
          <th class="py-1 pr-1 w-1/6">Updated</th>
          <th class="py-1 pr-0 w-1/6">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% cases.each do |entry| %>
          <% c = entry.case_detail %>
          <tr class="border-b">
            <td class="py-1 pr-1 align-top truncate max-w-[320px]" title="<%= c&.case_name %>">
              <%= c&.case_name.presence || "(untitled)" %>
            </td>
            <td class="py-1 pr-1 align-top break-words max-w-[320px]">
              <%= c&.full_citation.presence || "—" %>
            </td>
            <td class="py-1 pr-1 align-top text-gray-500 whitespace-nowrap">
              <%= l(entry.updated_at, format: :short) %>
            </td>
            <td class="py-1 pr-0 align-top whitespace-nowrap">
              <%= link_to "Show",  entry_path(entry), class: "underline" %>
              · <%= link_to "Edit", edit_entry_path(entry), class: "underline" %>
              <%= button_to "Delete",
                    entry_path(entry),
                    method: :delete,
                    data: { turbo_confirm: "Delete this case?" },
                    class: "underline text-red-600 bg-transparent p-0 border-0 cursor-pointer align-baseline ml-1" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p class="text-gray-600 mb-8">No cases in this subject yet.</p>
  <% end %>

  <!-- ——— Provisions by Act section ——— -->
  <div class="mt-6 mb-2 flex items-center justify-between">
    <h2 class="text-lg font-semibold">
      Provisions by Act <span class="text-sm text-gray-500">(<%= statutes.size %>)</span>
    </h2>
    <%= link_to "New statute",
          new_act_path(subject_id: @subject.id),
          class: "bg-brand-blue text-white px-3 py-2 rounded hover:bg-gold" %>
  </div>

  <% if grouped.any? %>
    <% grouped.each do |act, entries_for_act| %>
      <div id="act-<%= act&.id || 'legacy' %>" class="mb-6 rounded border border-gray-200">
        <div class="flex items-center justify-between bg-gray-50 px-3 py-2">
          <div class="text-sm">
            <% if act.present? %>
              <strong><%= act.display_name %></strong>
            <% else %>
              <strong>(No Act linked)</strong>
              <span class="text-gray-500 ml-1">Legacy provisions</span>
            <% end %>
          </div>
          <div class="text-sm">
            <% if act.present? %>
              <%= link_to "Edit Act", edit_act_path(act), class: "underline mr-2" %>
              <%= link_to "Add Provision", new_act_statute_path(act), class: "underline" %>
            <% end %>
          </div>
        </div>

        <table class="w-full text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="py-1 pr-1 w-1/3">Provision</th>
              <th class="py-1 pr-1 w-1/6">Updated</th>
              <th class="py-1 pr-0 w-1/6">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% entries_for_act.each do |entry| %>
              <% s = entry.statute_detail %>
              <tr class="border-b">
                <td class="py-1 pr-1 align-top break-words max-w-[320px]">
                  <%= s&.provision_ref.presence || "—" %>
                </td>
                <td class="py-1 pr-1 align-top text-gray-500 whitespace-nowrap">
                  <%= l(entry.updated_at, format: :short) %>
                </td>
                <td class="py-1 pr-0 align-top whitespace-nowrap">
                  <%= link_to "Show", entry_path(entry), class: "underline" %>
                  <% if s&.act %>
                    · <%= link_to "Edit", edit_act_statute_path(s.act, s), class: "underline" %>
                  <% else %>
                    · <%= link_to "Edit", edit_entry_path(entry), class: "underline" %> <!-- legacy fallback -->
                  <% end %>
                  <%= button_to "Delete",
                        entry_path(entry),
                        method: :delete,
                        data: { turbo_confirm: "Delete this statute?" },
                        class: "underline text-red-600 bg-transparent p-0 border-0 cursor-pointer align-baseline ml-1" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  <% else %>
    <p class="text-gray-600">No provisions in this subject yet.</p>
  <% end %>
<% end %>
