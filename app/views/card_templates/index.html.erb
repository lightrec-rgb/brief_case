<h1 class="text-2xl font-semibold mb-4">
  Entries
  <% if @subject.present? && @entries.present? %>
    <span class="ml-2 text-sm text-gray-500">(<%= @entries.size %>)</span>
  <% end %>
</h1>

<div class="mb-4 flex items-center gap-3">
  <%= form_with url: entries_path, method: :get, local: true, class: "flex items-center gap-2" do %>
    <label class="text-sm text-gray-600">Subject</label>
    <%= select_tag :subject_id,
      options_for_select(subject_options_for_select(current_user), @subject&.id),
      include_blank: current_user.subjects.empty?,
      class: "border rounded px-2 py-1",
      onchange: "this.form.requestSubmit()" %>
  <% end %>
</div>

<% if @subject.nil? %>
  <p class="text-gray-600">Create a subject first to add entries.</p>
<% else %>
  <%# ---------------- Partition + sort ---------------- %>
  <% cases = @entries.select { |e| e.kind == "Case" }.sort_by do |e|
       c = e.case_detail
       [c&.case_name.to_s.strip.downcase, e.id]
     end %>

  <% provisions = @entries.select { |e| e.kind == "Provision" }.sort_by do |e|
       pd = e.provision_detail
       [pd&.act&.display_name.to_s.downcase, pd&.provision_ref.to_s.downcase, e.id]
     end %>

  <!-- CASES SECTION -->
  <section class="mt-6">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-lg font-semibold">Cases in this subject</h2>
      <%= link_to "New case",
            new_entry_path(subject_id: @subject.id, kind: "Case"),
            class: "bg-brand-blue text-white px-3 py-2 rounded hover:bg-gold" %>
    </div>

    <% if cases.none? %>
      <p class="text-gray-600">No cases yet.</p>
    <% else %>
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left border-b">
            <th class="py-1 pr-1 w-1/2">Name</th>
            <th class="py-1 pr-1 w-1/4">From topic</th>
            <th class="py-1 pr-0 w-1/4 text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% cases.each do |entry| %>
            <% c = entry.case_detail %>
            <tr class="border-b hover:bg-gray-50 cursor-pointer"
                onclick="window.location='<%= entry_path(entry) %>'"
                role="link" tabindex="0">
              <td class="py-1 pr-1 align-top truncate max-w-[480px]" title="<%= c&.full_citation %>">
                <%= c&.full_citation.presence || "(untitled)" %>
              </td>
              <td class="py-1 pr-1 align-top text-gray-500">
                <%= entry.subject&.name || "(unknown topic)" %>
              </td>
              <td class="py-1 pr-0 align-top">
                <div class="flex justify-center items-center gap-2 whitespace-nowrap">
                  <%= link_to "Edit", edit_entry_path(entry), class: "underline" %>
                  <%= button_to "Delete",
                        entry_path(entry),
                        method: :delete,
                        data: { turbo_confirm: "Delete this case?" },
                        form:  { class: "inline" },
                        class: "underline text-black bg-transparent p-0 border-0 cursor-pointer align-baseline" %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </section>

  <!-- ACTS SECTION -->
  <section class="mt-10">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-lg font-semibold">Acts in this subject</h2>
      <%= link_to "New act",
            new_act_path(subject_id: @subject.id),
            class: "bg-brand-blue text-white px-3 py-2 rounded hover:bg-gold" %>
    </div>

    <% if @acts.blank? %>
      <p class="text-gray-600">No Acts yet.</p>
    <% else %>
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left border-b">
            <th class="py-1 pr-1 w-1/2">Act</th>
            <th class="py-1 pr-1 w-1/4">Provisions</th>
            <th class="py-1 pr-0 w-1/4 text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @acts.each do |act| %>
            <tr class="border-b" id="act-<%= act.id %>">
              <td class="py-1 pr-1 align-top"><%= act.display_name %></td>
              <td class="py-1 pr-1 align-top"><%= act.provisions.size %></td>
              <td class="py-2 pr-2">
                <div class="flex justify-center items-center gap-2 whitespace-nowrap">
                  <%= link_to "Add Provision",
                        new_act_provision_path(act, subject_id: @subject.id),
                        class: "underline" %>
                  <%= link_to "Edit Act", edit_act_path(act), class: "underline" %>
                  <% if act.provisions.exists? %>
                    <span class="text-gray-400" title="Delete provisions first">Delete Act</span>
                  <% else %>
                    <%= button_to "Delete Act",
                          act_path(act),
                          method: :delete,
                          data: { turbo_confirm: "Delete this Act?" },
                          form:  { class: "inline" },
                          class: "underline text-red-600 bg-transparent p-0 border-0 cursor-pointer align-baseline" %>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </section>

  <!-- PROVISIONS BY ACT SECTION -->
  <section class="mt-10">
    <h2 class="text-lg font-semibold mb-2">
      Provisions by Act for <%= @subject.name %>
    </h2>

    <% if provisions.none? %>
      <p class="text-gray-600">No provisions yet.</p>
    <% else %>
      <% grouped = provisions.group_by { |e| e.provision_detail&.act || :__unlinked } %>

      <% grouped.each do |act_or_key, entries_for_act| %>
        <% if act_or_key == :__unlinked %>
          <h3 class="text-md font-semibold mt-6 mb-2">Unlinked provisions</h3>
        <% else %>
          <% act = act_or_key %>
          <div class="flex items-center justify-between">
            <h3 class="text-md font-semibold mt-6 mb-2"><%= act.display_name %></h3>
            <div>
              <%= link_to "Add Provision",
                    new_act_provision_path(act, subject_id: @subject.id),
                    class: "underline text-sm" %>
            </div>
          </div>
        <% end %>

        <table class="w-full text-sm mb-4">
          <thead>
            <tr class="text-left border-b">
              <th class="py-1 pr-1 w-1/2">Provision (ref + summary)</th>
              <th class="py-1 pr-1 w-1/4">From topic</th>
              <th class="py-1 pr-0 w-1/4 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% entries_for_act.each do |entry| %>
              <% s = entry.provision_detail %>
              <tr class="border-b hover:bg-gray-50 cursor-pointer"
                  onclick="window.location='<%= entry_path(entry) %>'"
                  role="link" tabindex="0">
                <td class="py-1 pr-1 align-top">
                  <div class="max-w-[480px] truncate">
                    <span class="font-medium"><%= s&.provision_ref.presence || "—" %></span>
                    <% if s&.summary.present? %>
                      <span class="text-gray-500"> · </span>
                      <span class="text-gray-700"><%= s.summary %></span>
                    <% end %>
                  </div>
                </td>
                <td class="py-1 pr-1 align-top text-gray-500">
                  <%= entry.subject&.name || "(unknown topic)" %>
                </td>
                <td class="py-1 pr-0 align-top">
                  <div class="flex justify-center items-center gap-2 whitespace-nowrap">
                    <% if s&.act %>
                      <%= link_to "Edit",
                            edit_act_provision_path(s.act, s, subject_id: @subject.id),
                            class: "underline" %>
                      <%= button_to "Delete",
                            act_provision_path(s.act, s, subject_id: @subject.id),
                            method: :delete,
                            data: { turbo_confirm: "Delete this provision?" },
                            form:  { class: "inline" },
                            class: "underline text-black bg-transparent p-0 border-0 cursor-pointer align-baseline" %>
                    <% else %>
                      <span class="text-gray-400">No Act</span>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
    <% end %>
  </section>
<% end %>
