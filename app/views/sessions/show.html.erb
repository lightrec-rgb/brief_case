<%# app/views/sessions/show.html.erb %>

<div class="mb-3 flex items-center justify-between">
  <h1 class="text-2xl font-semibold">
    <%= @session.name.presence || "Session ##{@session.id}" %>
  </h1>
  <div>
    <%= session_status_badge(@session) %>
  </div>
</div>

<%# Progress (due-based) %>
<% new_cards    = @session.new_count %>
<% review_cards = @session.review_count %>
<% due_now      = @session.due_count %>

<p class="text-gray-600 mb-4">
  Subject: <strong><%= @session.subject&.name %></strong> Â·
  New: <strong><%= new_cards %></strong> Â·
  Review (total): <strong><%= review_cards %></strong> Â·
  Due now: <strong><%= due_now %></strong>/<%= @session.total_count %>
</p>

<%# Current item %>
<% si = @item || @session.prepare_current_item! %>

<% if si.present? %>
  <% options = si.preview_options %>

  <div class="relative overflow-hidden rounded-2xl border shadow-sm bg-white">
    <!-- Header (absolute background, clipped by parent's rounded corners) -->
    <div class="relative">
      <div class="absolute inset-0 bg-gray-50"></div>
      <div class="relative px-4 py-3">
        <div class="text-xs text-gray-600">Card <%= si.position %> of <%= @session.total_count %></div>
      </div>
      <!-- Inset divider avoids cutting across curved corners -->
      <div class="relative h-px bg-gray-200 mx-4"></div>
    </div>

    <!-- Body -->
    <div class="p-4">
      <h2 class="font-semibold mb-2 text-gray-900">Question</h2>
      <p class="mb-4 whitespace-pre-line text-gray-900"><%= si.question.presence || "(No question text)" %></p>

      <!-- Reveal (no arrow; simple toggle) -->
      <div id="reveal" class="mt-2">
        <button
          id="reveal-btn"
          type="button"
          class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-brand-blue text-white hover:bg-gold transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-blue"
          onclick="document.getElementById('answer').classList.remove('hidden'); document.getElementById('reveal').classList.add('hidden'); this.setAttribute('aria-expanded','true');"
          aria-controls="answer"
          aria-expanded="false"
        >
          <span class="inline-block w-2 h-2 rounded-full bg-white/80"></span>
          <span class="font-medium">Show answer</span>
          <span class="ml-1 text-xs opacity-80">(Click / Space)</span>
        </button>
      </div>
      
      <script>
        (function () {
          const btn = document.getElementById('reveal-btn');
          if (!btn) return;

          document.addEventListener('keydown', function (e) {
            // Space key (also handle older keyCode)
            if ((e.code === 'Space' || e.key === ' ' || e.keyCode === 32)) {
              // Only act if the reveal block is still visible (answer is hidden)
              const reveal = document.getElementById('reveal');
              const answer = document.getElementById('answer');
              if (reveal && !reveal.classList.contains('hidden') && answer && answer.classList.contains('hidden')) {
                e.preventDefault(); // stop page from scrolling
                btn.click();        // trigger the same logic as clicking
              }
            }
          }, { capture: true });
        })();
      </script>

      <!-- Answer + ratings -->
      <div id="answer" class="hidden">
        <h2 class="font-semibold mt-4 mb-2 text-gray-900">Answer</h2>
        <p class="whitespace-pre-line mb-4 text-gray-900"><%= si.answer.presence || "(No answer text)" %></p>

        <%= form_with url: advance_session_path(@session), method: :post do %>
          <table class="w-full table-fixed text-center">
            <colgroup>
              <col class="w-1/4">
              <col class="w-1/4">
              <col class="w-1/4">
              <col class="w-1/4">
            </colgroup>

            <!-- Row 1: time previews -->
            <tr class="text-[11px] text-gray-600">
              <% [1,2,3,4].each do |rating| %>
                <% info = options[rating] %>
                <td class="px-1 py-1 align-middle">
                  <% if info.present? %>
                    <% due = info[:due_at] %>
                    <span title="<%= l(due, format: :long) %>">
                      <%= distance_of_time_in_words(Time.current, due, include_seconds: true) %>
                    </span>
                  <% else %>
                    â€”
                  <% end %>
                </td>
              <% end %>
            </tr>

            <!-- Row 2: buttons (forced one row) -->
            <tr>
              <td class="px-1 py-1">
                <button name="rating" value="1" type="submit"
                        class="w-full px-3 py-2 rounded-lg border bg-white hover:bg-gray-50 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                  Again
                </button>
              </td>
              <td class="px-1 py-1">
                <button name="rating" value="2" type="submit"
                        class="w-full px-3 py-2 rounded-lg border bg-white hover:bg-gray-50 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                  Hard
                </button>
              </td>
              <td class="px-1 py-1">
                <button name="rating" value="3" type="submit"
                        class="w-full px-3 py-2 rounded-lg border bg-white hover:bg-gray-50 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                  Good
                </button>
              </td>
              <td class="px-1 py-1">
                <button name="rating" value="4" type="submit"
                        class="w-full px-3 py-2 rounded-lg border bg-white hover:bg-gray-50 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                  Easy
                </button>
              </td>
            </tr>
          </table>
        <% end %>
      </div> <!-- /#answer -->
    </div> <!-- /p-4 -->
  </div> <!-- /card -->

  <div class="mt-4">
    <p class="text-sm text-gray-500 mb-2">Progress saves automatically. You can leave any time and return via Learn.</p>
    <%= link_to 'Back to Learn', sessions_path, class: 'underline text-brand-blue hover:text-gold' %>
  </div>

<% else %>
  <div class="rounded-2xl border p-4 bg-green-50">
    <p class="font-semibold mb-2 text-green-900">All caught up for now ðŸŽ‰</p>
    <p class="text-green-900">Nothing is due at this moment. Come back when cards are due again.</p>
  </div>
  <div class="mt-4">
    <%= link_to 'Back to Learn', sessions_path, class: 'underline text-brand-blue hover:text-gold' %>
  </div>
<% end %>

<% next_due = @session.session_items.where("due_at > ?", Time.current.utc).minimum(:due_at) %>
<% if next_due.present? %>
  <script>
    (function () {
      function scheduleReload() {
        var serverNow = new Date("<%= Time.current.utc.iso8601 %>");
        var nextDue   = new Date("<%= next_due.utc.iso8601 %>");
        var now       = new Date();
        // compensate for server/client skew using the delta we know at render time
        var skewMs    = serverNow.getTime() - now.getTime();
        var msUntil   = nextDue.getTime() - (now.getTime() + skewMs);
        var MAX_WAIT_MS = 10 * 60 * 1000; // 10 minutes
        if (msUntil > 0 && msUntil <= MAX_WAIT_MS) {
          setTimeout(function(){ window.location.reload(); }, msUntil + 300);
        }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", scheduleReload);
      } else {
        scheduleReload();
      }
      document.addEventListener("turbo:load", scheduleReload);
    })();
  </script>
<% end %>