<h1 class="text-2xl font-semibold mb-4">Learn</h1>

<div class="mb-4">
  <%= link_to "Create new session", new_session_path, class: "bg-brand-blue text-white px-3 py-2 rounded hover:bg-gold" %>
</div>

<%# ---------------- ACTIVE (non-completed) ---------------- %>
<% if @active_sessions.blank? %>
  <p class="text-gray-600">No active sessions. Start one now, or reopen one from the archive below</p>
<% else %>
  <% grouped_active = @active_sessions.group_by(&:subject) %>

  <% grouped_active.each do |subject, sessions| %>
    <div class="mt-8">
      <h2 class="text-lg font-semibold mb-2">
        <%= subject ? subject.path.map(&:name).join(" › ") : "(No subject)" %>
      </h2>

      <table class="w-full text-sm">
        <thead>
          <tr class="border-b">
            <th class="py-2 pr-2 text-left">Name</th>
            <th class="py-2 px-2 text-center">Total</th>
            <th class="py-2 px-2 text-center">New</th>
            <th class="py-2 px-2 text-center">Due</th>
            <th class="py-2 px-2 text-left">Status</th>
            <th class="py-2 px-2 text-left">Updated</th>
            <th class="py-2 px-2 text-center">Actions</th>
          </tr>
        </thead>

        <tbody>
          <% sessions.each do |s| %>
            <% total     = s.total_count.to_i %>
            <% new_cards = s.new_count.to_i %>
            <% due_now   = s.due_count.to_i %>

            <tr class="border-b align-middle">
              <td class="py-2 pr-2 align-middle">
                <div class="font-medium"><%= s.name.presence || "Session ##{s.id}" %></div>

                <div class="text-xs text-gray-500 h-5">
                  <% now = Time.current.utc %>
                  <% next_due_any = s.session_items.to_a
                                     .select { |si| si.due_at && si.due_at > now && si.fsrs_state_i != Fsrs::State::NEW }
                                     .map(&:due_at).min %>
                  <% if next_due_any.present? && due_now.zero? %>
                    Next due:
                    <span
                      class="next-due-countdown"
                      data-next-due="<%= next_due_any.utc.iso8601 %>"
                      data-server-now="<%= Time.current.utc.iso8601 %>">
                      <%= distance_of_time_in_words(Time.current, next_due_any, include_seconds: false) %>
                    </span>
                  <% end %>
                </div>
              </td>

              <td class="py-2 px-2 text-center whitespace-nowrap align-middle">
                <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-700">
                  <strong class="ml-1"><%= total %></strong>
                </span>
              </td>

              <td class="py-2 px-2 text-center whitespace-nowrap align-middle">
                <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs
                            <%= new_cards.positive? ? "bg-[#e6f0ff] text-blue-700 font-bold" : "bg-[#e6f0ff] text-[#0b57d0]" %>">
                  New <strong class="ml-1"><%= new_cards %></strong>
                </span>
              </td>

              <td class="py-2 px-2 text-center whitespace-nowrap align-middle">
                <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs
                            <%= due_now.positive? ? "bg-[#e9f7ef] text-emerald-700 font-bold" : "bg-[#e9f7ef] text-[#1e7e34]" %>">
                  Due <strong class="ml-1"><%= due_now %></strong>
                </span>
              </td>

              <td class="py-2 px-2 align-middle"><%= session_status_badge(s) %></td>
              <td class="py-2 px-2 text-gray-500 align-middle"><%= l(s.updated_at, format: :short) %></td>

              <td class="py-2 px-2 text-center align-middle">
                <div class="inline-flex items-center gap-2">
                  <%= link_to "Start",
                        session_path(s),
                        class: "inline-block bg-brand-blue text-white px-2.5 py-1.5 rounded hover:bg-gold text-xs font-medium" %>

                  <%= button_to "Reset",
                        reset_session_path(s),
                        method: :post,
                        form:  {
                          data: { turbo_confirm: "Reset this session? Progress will be cleared." },
                          onsubmit: "return confirm('Reset this session? Progress will be cleared.');",
                          class: "inline"
                        },
                        class: "underline bg-transparent p-0 border-0 cursor-pointer align-middle text-xs" %>

                  <%= button_to "Complete",
                        complete_session_path(s),
                        method: :post,
                        form:  {
                          data: { turbo_confirm: "Mark this session as completed? It will stop surfacing due cards." },
                          onsubmit: "return confirm('Mark this session as completed? It will stop surfacing due cards.');",
                          class: "inline"
                        },
                        class: "underline text-black bg-transparent p-0 border-0 cursor-pointer align-middle text-xs" %>

                  <%= button_to "Delete",
                        session_path(s),
                        method: :delete,
                        form:  {
                          data: { turbo_confirm: "Delete this session? You’ll lose its progress permanently." },
                          onsubmit: "return confirm('Delete this session? You’ll lose its progress permanently.');",
                          class: "inline"
                        },
                        class: "underline text-black bg-transparent p-0 border-0 cursor-pointer align-middle text-xs" %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>
<% end %>

<%# ---------------- ARCHIVE (completed) ---------------- %>
<div class="mt-12">
  <h2 class="text-lg font-semibold mb-2">Archived sessions</h2>

  <% if @archived_sessions.blank? %>
    <p class="text-gray-500">No archived sessions.</p>
  <% else %>
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b">
          <th class="py-2 pr-2 text-left">Name</th>
          <th class="py-2 px-2 text-left">Subject</th> <%# NEW COLUMN %>
          <th class="py-2 px-2 text-center">Total</th>
          <th class="py-2 px-2 text-left">Completed</th>
          <th class="py-2 px-2 text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @archived_sessions.each do |s| %>
          <tr class="border-b align-middle text-gray-600">
            <td class="py-2 pr-2 align-middle">
              <div class="font-medium"><%= s.name.presence || "Session ##{s.id}" %></div>
            </td>

            <%# SUBJECT NOW SHOWN HERE %>
            <td class="py-2 px-2 align-middle text-gray-700">
              <%= s.subject ? s.subject.path.map(&:name).join(" › ") : "(No subject)" %>
            </td>

            <td class="py-2 px-2 text-center whitespace-nowrap align-middle">
              <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-700">
                <strong class="ml-1"><%= s.total_count.to_i %></strong>
              </span>
            </td>

            <td class="py-2 px-2 align-middle">
              <%= l(s.completed_at || s.updated_at, format: :short) %>
            </td>

            <td class="py-2 px-2 text-center align-middle">
              <div class="inline-flex items-center gap-2">
                <%= button_to "Reopen",
                      reopen_session_path(s), # uses SessionsController#reopen
                      method: :post,
                      class: "inline-block bg-brand-blue text-white px-2.5 py-1.5 rounded hover:bg-gold text-xs font-medium" %>

                <%= button_to "Delete",
                      session_path(s),
                      method: :delete,
                      form: {
                        data: { turbo_confirm: "Delete this archived session?" },
                        onsubmit: "return confirm('Delete this archived session?');",
                        class: "inline"
                      },
                      class: "underline text-black bg-transparent p-0 border-0 cursor-pointer align-middle text-xs" %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>
</div>

<%# ---------- Live countdown + auto-refresh (leave as-is) ---------- %>
<script>
(function () {
  var els = document.querySelectorAll(".next-due-countdown");
  if (!els.length) return;
  var ref = els[0];
  var serverNowStr = ref.getAttribute("data-server-now");
  var skewMs = Date.parse(serverNowStr) - Date.now();

  function fmt(ms) {
    var s = Math.max(0, Math.floor(ms / 1000));
    var h = Math.floor(s / 3600);
    var m = Math.floor((s % 3600) / 60);
    var sec = s % 60;
    if (h > 0) return h + "h " + String(m).padStart(2, "0") + "m";
    if (m > 0) return m + "m " + String(sec).padStart(2, "0") + "s";
    return sec + "s";
  }

  function tick() {
    var any = false;
    els.forEach(function (el) {
      var nextDueStr = el.getAttribute("data-next-due");
      if (!nextDueStr) return;

      any = true;
      var nextDue = Date.parse(nextDueStr);
      var nowAdj = Date.now() + skewMs;
      var msLeft = nextDue - nowAdj;

      if (msLeft <= 0) {
        el.textContent = "now";
        if (!document.hidden) setTimeout(function () { window.location.reload(); }, 300);
      } else {
        el.textContent = fmt(msLeft);
      }
    });

    if (!any) clearInterval(interval);
  }

  tick();
  var interval = setInterval(tick, 1000);

  document.addEventListener("visibilitychange", function () {
    if (document.hidden) {
      clearInterval(interval);
    } else {
      tick();
      interval = setInterval(tick, 1000);
    }
  });

  document.addEventListener("turbo:before-cache", function () {
    clearInterval(interval);
  });
})();
</script>
